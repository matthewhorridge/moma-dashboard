<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MET CSV Dashboard (Light + Artist)</title>
  <link rel="icon" href="data:," />
  <style>
    :root {
      --bg:#f7fafc;
      --card:#ffffff;
      --muted:#64748b;
      --text:#0f172a;
      --accent:#2563eb;
      --bad:#b91c1c;
      --border:#e5e7eb;
      --input:#ffffff;
      --input-border:#cbd5e1;
      --btn:#f1f5f9;
      --btn-hover:#e2e8f0;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; }
    header { position: sticky; top:0; background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 1000px) { .row { grid-template-columns: 300px 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
    .muted { color: var(--muted); }
    input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--input-border); background:var(--input); color: var(--text); }
    input[type="range"] { width: 100%; }
    .btn { cursor: pointer; background: var(--btn); color: var(--text); border: 1px solid var(--input-border); padding: 8px 12px; border-radius: 10px; }
    .btn:hover { background: var(--btn-hover); }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f2f5fb; border:1px solid var(--border); margin-right:6px; color:#0f172a; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { text-align: left; color: var(--muted); font-weight: 600; }
    .footer { color: var(--muted); font-size: 12px; text-align: center; padding: 16px 0 24px; }
    canvas { width: 100% !important; height: 320px !important; }
    .err { color: var(--bad); white-space: pre-wrap; word-break: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div>
        <div style="font-weight:700;">MET CSV Dashboard</div>
        <div class="muted" style="font-size:12px;">Load <code>met_top20k.csv</code> — Client-only, no backend</div>
      </div>
      <div>
        <input id="fileInput" type="file" accept=".csv,text/csv" class="btn" />
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <!-- Filters -->
      <aside class="card" style="position:sticky; top:76px; height:fit-content;">
        <div style="display:grid; gap:10px;">
          <div>
            <div class="muted" style="font-size:12px; margin-bottom:6px;">Search (title / department / culture / classification / artist / nationality)</div>
            <input id="q" type="text" placeholder="Type to filter…" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; margin-bottom:6px;">Year range</div>
            <div style="display:grid; gap:6px;">
              <input id="yearMin" type="range" min="-600" max="2025" value="-600" />
              <input id="yearMax" type="range" min="-600" max="2025" value="2025" />
              <div class="muted"><span id="yearMinVal">-600</span> → <span id="yearMaxVal">2025</span></div>
            </div>
          </div>
          <div style="display:flex; gap:8px;">
            <button id="clearBtn" class="btn">Clear</button>
            <button id="exportBtn" class="btn">Export filtered CSV</button>
          </div>
          <div id="status" class="muted" style="font-size:12px;">No file loaded.</div>
          <div id="errors" class="err"></div>
        </div>
      </aside>

      <!-- Main -->
      <section style="display:grid; gap:16px;">
        <div class="card">
          <div style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
            <div>
              <div style="font-weight:600;">Objects by Department</div>
              <div class="muted" style="font-size:12px;">Top 15 departments in the filtered set</div>
            </div>
            <div class="muted" style="font-size:12px;"><span id="count">0</span> results</div>
          </div>
          <div style="margin-top:8px;">
            <canvas id="deptChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:600; margin-bottom:6px;">Results (first 50)</div>
          <div style="overflow:auto;">
            <table id="table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Artist</th>
                  <th>Nationality</th>
                  <th>Department</th>
                  <th>Classification</th>
                  <th>Begin</th>
                  <th>End</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <div class="footer">Client-only • CSV stays on your machine • Built with Papa Parse + Chart.js</div>
  </main>

  <!-- Libraries from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <script>
    const state = { rows: [], filtered: [], columns: [], chart: null };
    const el = (id) => document.getElementById(id);
    const fileInput = el('fileInput'), q = el('q'), yearMin = el('yearMin'), yearMax = el('yearMax');
    const yearMinVal = el('yearMinVal'), yearMaxVal = el('yearMaxVal'), status = el('status'), errors = el('errors');
    const count = el('count'), exportBtn = el('exportBtn'), clearBtn = el('clearBtn');

    const EXPECTED = {
      title: 'title',
      department: 'department',
      classification: 'classification',
      culture: 'culture',
      begin: 'object_begin_date',
      end: 'object_end_date',
      artist: 'artist_display_name',
      nationality: 'artist_nationality',
      artist_begin: 'artist_begin_date',
      artist_end: 'artist_end_date'
    };

    fileInput.addEventListener('change', (e) => { const file = e.target.files?.[0]; if (!file) return; errors.textContent=''; loadCSV(file); });
    clearBtn.addEventListener('click', () => { q.value=''; yearMin.value='-600'; yearMax.value='2025'; yearMinVal.textContent='-600'; yearMaxVal.textContent='2025'; if (state.rows.length) applyFilters(); });
    q.addEventListener('input', debounce(applyFilters, 150));
    yearMin.addEventListener('input', () => { if (+yearMin.value > +yearMax.value) yearMax.value = yearMin.value; yearMinVal.textContent=yearMin.value; yearMaxVal.textContent=yearMax.value; applyFilters(); });
    yearMax.addEventListener('input', () => { if (+yearMax.value < +yearMin.value) yearMin.value = yearMax.value; yearMinVal.textContent=yearMin.value; yearMaxVal.textContent=yearMax.value; applyFilters(); });

    exportBtn.addEventListener('click', () => {
      if (!state.filtered.length) return;
      const csv = toCSV(state.filtered, state.columns);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'met_filtered.csv'; a.click(); URL.revokeObjectURL(url);
    });

    function loadCSV(file) {
      status.textContent = 'Parsing…';
      try {
        Papa.parse(file, {
          header: true, dynamicTyping: true, skipEmptyLines: true,
          transformHeader: (h) => (h || '').toString().trim(),
          complete: (res) => {
            if (res.errors && res.errors.length) errors.textContent = 'Parser warnings/errors:\n' + res.errors.slice(0,5).map(e => e.message + ' @ row ' + e.row).join('\n');
            if (!res.data || !res.data.length) { status.textContent = 'No rows found.'; return; }
            const cols = res.meta && res.meta.fields ? res.meta.fields.map(c => c.trim()) : Object.keys(res.data[0]);
            const mapping = buildHeaderMapping(cols);
            const missing = Object.keys(EXPECTED).filter(k => !(EXPECTED[k] in mapping.map));
            if (missing.length) { /* don't block; just note */ console.warn('Missing columns:', missing); }
            state.rows = res.data.map(r => normalizeRow(r, mapping));
            state.columns = cols;
            status.textContent = `Loaded ${state.rows.length.toLocaleString()} rows • ${state.columns.length} columns`;
            applyFilters();
          },
          error: (err) => { console.error(err); status.textContent = 'Error parsing CSV'; errors.textContent = String(err); }
        });
      } catch (ex) { status.textContent = 'Error parsing CSV'; errors.textContent = String(ex && ex.stack || ex); }
    }

    function buildHeaderMapping(cols) {
      const map = {}; cols.forEach(c => map[c.toLowerCase()] = c);
      return { map };
    }

    function normalizeRow(r, mapping) {
      const low = {}; for (const k in r) if (Object.prototype.hasOwnProperty.call(r,k)) low[k.toLowerCase()] = r[k];
      // Canonicalized keys for our UI
      return {
        title: val(low[EXPECTED.title]),
        department: val(low[EXPECTED.department]),
        classification: val(low[EXPECTED.classification]),
        culture: val(low[EXPECTED.culture]),
        object_begin_date: num(low[EXPECTED.begin]),
        object_end_date: num(low[EXPECTED.end]),
        artist_display_name: val(low[EXPECTED.artist]),
        artist_nationality: val(low[EXPECTED.nationality]),
        artist_begin_date: num(low[EXPECTED.artist_begin]),
        artist_end_date: num(low[EXPECTED.artist_end]),
        // keep all original fields (lowercased) so export keeps full data
        ...low
      };
    }

    function applyFilters() {
      const query = (q.value || '').toLowerCase().trim();
      const ymin = +yearMin.value, ymax = +yearMax.value;
      const filtered = [];
      for (const r of state.rows) {
        const t = val(r['title']).toLowerCase();
        const d = val(r['department']).toLowerCase();
        const c = val(r['culture']).toLowerCase();
        const cl = val(r['classification']).toLowerCase();
        const a = val(r['artist_display_name']).toLowerCase();
        const n = val(r['artist_nationality']).toLowerCase();
        if (query && !(t.includes(query) || d.includes(query) || c.includes(query) || cl.includes(query) || a.includes(query) || n.includes(query))) continue;

        const b = num(r['object_begin_date']), e = num(r['object_end_date']);
        if (Number.isFinite(b) || Number.isFinite(e)) { const lo = Number.isFinite(b) ? b : e, hi = Number.isFinite(e) ? e : b; if (!(lo <= ymax && hi >= ymin)) continue; }
        filtered.push(r);
      }
      state.filtered = filtered;
      el('count').textContent = filtered.length.toLocaleString();
      renderTable(filtered.slice(0, 50));
      renderDeptChart(filtered);
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#table tbody'); tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(val(r['title']))}</td>
          <td>${escapeHTML(val(r['artist_display_name']))}</td>
          <td>${escapeHTML(val(r['artist_nationality']))}</td>
          <td><span class="pill">${escapeHTML(val(r['department']))}</span></td>
          <td>${escapeHTML(val(r['classification']))}</td>
          <td>${escapeHTML(num(r['object_begin_date']))}</td>
          <td>${escapeHTML(num(r['object_end_date']))}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderDeptChart(rows) {
      const ctx = document.getElementById('deptChart').getContext('2d');
      const counts = new Map();
      for (const r of rows) { const d = val(r['department']); counts.set(d, (counts.get(d) || 0) + 1); }
      const sorted = Array.from(counts.entries()).filter(([k]) => k).sort((a,b)=>b[1]-a[1]).slice(0,15);
      const labels = sorted.map(x=>x[0]); const data = sorted.map(x=>x[1]);
      if (window._deptChart) window._deptChart.destroy();
      window._deptChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Count', data }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { x: { ticks: { color: '#334155' } }, y: { ticks: { color: '#334155' } } },
          plugins: { legend: { labels: { color: '#334155' } } }
        }
      });
    }

    // Helpers
    function num(v) { const n = Number(v); return Number.isFinite(n) ? n : NaN; }
    function val(v) { return (v === null || v === undefined) ? '' : String(v); }
    function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; }
    function escapeHTML(s) { return String(s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }
    function toCSV(rows, cols) { if (!cols || !cols.length) cols = Object.keys(rows[0] || {}); const header = cols.join(','); const lines = [header]; for (const r of rows) { const line = cols.map(k => csvEscape(r[k])); lines.push(line.join(',')); } return lines.join('\n'); }
    function csvEscape(v) { if (v === null || v === undefined) return ''; const s = String(v); if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"'; return s; }
  </script>
</body>
</html>
