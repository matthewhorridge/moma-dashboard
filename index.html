<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MET Dashboard — Sort • Paging • Columns • Sticky Header</title>
  <link rel="icon" href="data:," />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css">
  <style>
    :root {
      --bg: #f5f7fb;
      --bg-accent: radial-gradient(1200px 600px at 80% -10%, rgba(99,102,241,0.12), transparent 60%),
                   radial-gradient(800px 400px at -10% 20%, rgba(16,185,129,0.10), transparent 60%);
      --card: #ffffff;
      --muted: #667085;
      --text: #0f172a;
      --ring: 0 0 0 4px rgba(59,130,246,0.20);
      --border: #e6e8ee;
      --input: #ffffff;
      --input-border: #d7dbe3;
      --btn: linear-gradient(180deg,#f8faff,#eef2ff);
      --btn-hover: linear-gradient(180deg,#eef2ff,#e0e7ff);
      --primary: #3b82f6;
      --chip-bg:#f1f5ff; --chip-border:#c7d2fe; --chip-text:#1e293b;
      --shadow-sm: 0 1px 2px rgba(16,24,40,0.05);
      --shadow-md: 0 8px 24px rgba(2,6,23,0.08);
      --shadow-lg: 0 20px 40px rgba(2,6,23,0.12);
      --thead-bg: #fbfdff;
    }
    * { box-sizing:border-box; }
    body {
      margin:0; color:var(--text);
      background: var(--bg); background-image: var(--bg-accent);
      font: 14px/1.6 "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    header { position: sticky; top:0; z-index:50; background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1240px; margin: 0 auto; padding: 16px 20px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo { width: 34px; height: 34px; border-radius: 10px; background: linear-gradient(180deg,#3b82f6,#6366f1); box-shadow: var(--shadow-sm); display:grid; place-items:center; color:#fff; font-weight:700; }
    .title { font-weight:700; font-size:16px; }
    .subtitle { color:var(--muted); font-size:12px; }
    .row { display:grid; grid-template-columns: 1fr; gap: 18px; margin-top: 16px; }
    @media (min-width: 1080px) { .row { grid-template-columns: 340px 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: var(--shadow-md); }
    .card h3 { margin: 0 0 8px; font-size: 14px; font-weight: 600; }
    .muted { color: var(--muted); }
    .input { width:100%; padding: 12px 12px 12px 40px; border-radius: 12px; border:1px solid var(--input-border); background:var(--input); transition: box-shadow .15s ease, border-color .15s ease; }
    .input:focus { outline:none; border-color: #93c5fd; box-shadow: var(--ring); }
    .field { position:relative; }
    .field svg { position:absolute; left:12px; top:50%; transform: translateY(-50%); opacity:.6; }
    input[type="range"] { width:100%; }
    .btn { cursor:pointer; background: var(--btn); border:1px solid var(--input-border); color:#0f172a; padding: 10px 14px; border-radius: 12px; font-weight:600; box-shadow: var(--shadow-sm); transition: transform .05s ease, box-shadow .15s ease, background .2s ease; }
    .btn:hover { background: var(--btn-hover); box-shadow: var(--shadow-md); }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: linear-gradient(180deg, #60a5fa, #3b82f6); border-color: rgba(59,130,246,0.4); color: #fff; }
    .btn-primary:hover { background: linear-gradient(180deg, #60a5fa, #2563eb); }
    .pill { display:inline-block; padding: 5px 9px; border-radius: 8px; background: var(--chip-bg); border:1px solid var(--chip-border); color:var(--chip-text); font-size: 12px; line-height: 1.2; }
    .chips-row { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { display:inline-flex; align-items:center; gap:6px; background:#eef2ff; border:1px solid #c7d2fe; color:#1e293b; padding:6px 10px; border-radius: 999px; font-size:12px; box-shadow: var(--shadow-sm); }
    .chip button { all:unset; cursor:pointer; padding:0 4px; opacity:.7; }
    .chip button:hover { opacity:1; }

    /* Table */
    .table-wrap { overflow:auto; max-height: 560px; border-radius: 12px; }
    table { width:100%; border-collapse: separate; border-spacing: 0; }
    thead th, tfoot th { position: sticky; top: 0; z-index: 2; background: var(--thead-bg); }
    thead th::after {
      content: ""; position:absolute; left:0; right:0; bottom:-1px; height:1px; background: var(--border);
    }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { text-align:left; color:#475569; font-weight:700; user-select:none; cursor:pointer; position: relative; }
    th .sort { margin-left:6px; opacity:.7; }
    tbody tr:hover { background: #f8fafc; }
    td img { border-radius: 8px; box-shadow: var(--shadow-sm); }

    canvas { width: 100% !important; height: 340px !important; }
    .err { color:#b91c1c; white-space: pre-wrap; word-break: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .listbox { position:relative; margin-top:8px; background:#fff; border:1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow-lg); max-height:260px; overflow:auto; padding:6px 0; }
    .option { padding:8px 10px; cursor:pointer; }
    .option:hover { background:#f8fafc; }
    .option[aria-selected="true"] { background:#eef2ff; }

    .controls { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .select { padding:8px 10px; border-radius:10px; border:1px solid var(--input-border); background:#fff; }

    .colpick { position:relative; display:inline-block; }
    .colpanel {
      position:absolute; right:0; top:calc(100% + 8px);
      background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow-lg);
      padding:10px; min-width:220px; z-index:10;
    }
    .colpanel h4 { margin: 0 0 8px; font-size:12px; color:#475569; }
    .colpanel label { display:flex; align-items:center; gap:8px; padding:6px 4px; border-radius:8px; cursor:pointer; }
    .colpanel label:hover { background:#f8fafc; }

    /* noUiSlider theming */
    .noUi-target { box-shadow: var(--shadow-sm); border:1px solid var(--input-border); border-radius: 10px; background:#fff; }
    .noUi-connect { background: linear-gradient(90deg, #60a5fa, #3b82f6); }
    .noUi-horizontal { height: 10px; }
    .noUi-handle { width: 18px; height: 18px; border-radius: 9px; box-shadow: var(--shadow-sm); border:1px solid #93c5fd; }
    .noUi-handle::before, .noUi-handle::after { display:none; }
    .noUi-pips-horizontal { padding-top: 6px; color:#667085; }
    .noUi-value { font-size: 10px; }
    .noUi-marker { background:#d0d5dd; }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:14px;">
      <div class="brand">
        <div class="logo">M</div>
        <div>
          <div class="title">MET Dashboard</div>
          <div class="subtitle">Client-only • Load <code>Artworks.csv</code> (MoMA)</div>
        </div>
      </div>
      <div><input id="fileInput" type="file" accept=".csv,text/csv" class="btn" /></div>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <aside class="card" style="position:sticky; top:92px; height:fit-content;">
        <div style="display:grid; gap:14px;">
          <div>
            <h3>Search</h3>
            <div class="field with-actions">
              <input id="q" class="input" type="text" placeholder="Title, department, classification, artist, nationality, medium…" />
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35m1.1-5.05a6.15 6.15 0 11-12.3 0 6.15 6.15 0 0112.3 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </div>
          </div>

          <div>
            <h3>Artist (multi)</h3>
            <div class="field with-actions">
              <input id="artistInput" class="input" type="text" placeholder="Type to search artists…" autocomplete="off" aria-autocomplete="list" aria-expanded="false" />
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35m1.1-5.05a6.15 6.15 0 11-12.3 0 6.15 6.15 0 0112.3 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
              <div class="actions">
                <button id="artistClear" class="btn" title="Clear">✕</button>
                <button id="artistToggle" class="btn" title="Show">▾</button>
              </div>
            </div>
            <div id="artistList" class="listbox" role="listbox" hidden></div>
            <div id="artistChips" class="chips-row" style="display:none;"></div>
          </div>

          <div>
            <h3>Classification (multi)</h3>
            <div class="field with-actions">
              <input id="classInput" class="input" type="text" placeholder="Type to search classification…" autocomplete="off" aria-autocomplete="list" aria-expanded="false" />
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35m1.1-5.05a6.15 6.15 0 11-12.3 0 6.15 6.15 0 0112.3 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
              <div class="actions">
                <button id="classClear" class="btn" title="Clear">✕</button>
                <button id="classToggle" class="btn" title="Show">▾</button>
              </div>
            </div>
            <div id="classList" class="listbox" role="listbox" hidden></div>
            <div id="classChips" class="chips-row" style="display:none;"></div>
          </div>

          <div>
            <h3>Medium (multi)</h3>
            <div class="field with-actions">
              <input id="tagsInput" class="input" type="text" placeholder="Type to search medium…" autocomplete="off" aria-autocomplete="list" aria-expanded="false" />
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35m1.1-5.05a6.15 6.15 0 11-12.3 0 6.15 6.15 0 0112.3 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
              <div class="actions">
                <button id="tagsClear" class="btn" title="Clear">✕</button>
                <button id="tagsToggle" class="btn" title="Show">▾</button>
              </div>
            </div>
            <div id="tagsList" class="listbox" role="listbox" hidden></div>
            <div id="tagsChips" class="chips-row" style="display:none;"></div>
          </div>

          <div>
            <h3>Year range</h3>
            <div style="display:grid; gap:10px;">
              <div id="yearSlider"></div>
              <div style="display:flex; gap:8px; align-items:center;">
                <label class="muted" style="font-size:12px;">From
                  <input id="yearMinBox" type="number" min="-600" max="2025" class="input" style="width:120px; padding:8px 10px; height:36px;" />
                </label>
                <label class="muted" style="font-size:12px;">To
                  <input id="yearMaxBox" type="number" min="-600" max="2025" class="input" style="width:120px; padding:8px 10px; height:36px;" />
                </label>
                <div class="muted" style="margin-left:auto; font-size:12px;"><span id="yearMinVal">-600</span> → <span id="yearMaxVal">2025</span></div>
              </div>
              <div class="chips-row">
                <button class="btn" data-range="all">All</button>
                <button class="btn" data-range="-600,0">≤ 0</button>
                <button class="btn" data-range="1400,1600">1400–1600</button>
                <button class="btn" data-range="1600,1800">1600–1800</button>
                <button class="btn" data-range="1800,1900">1800–1900</button>
                <button class="btn" data-range="1900,1950">1900–1950</button>
                <button class="btn" data-range="1950,2025">1950–2025</button>
              </div>
              <input id="yearMin" type="hidden" value="-600" />
              <input id="yearMax" type="hidden" value="2025" />
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="clearBtn" class="btn">Clear</button>
            <button id="exportBtn" class="btn btn-primary">Export filtered CSV</button>
          </div>
          <div id="status" class="muted" style="font-size:12px;">No file loaded.</div>
          <div id="errors" class="err"></div>
        </div>
      </aside>

      <section style="display:grid; gap:18px;">
        <div class="card">
          <div style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
            <div>
              <h3 style="margin:0;">Objects by Department</h3>
              <div class="muted" style="font-size:12px;">Top 15 departments in the filtered set</div>
            </div>
            <div class="muted" style="font-size:12px;"><span id="count" style="font-weight:700; color:#111827;">0</span> results</div>
          </div>
          <div style="margin-top:8px;">
            <canvas id="deptChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px;">
            <h3 style="margin:0;">Results</h3>
            <div class="controls">
              <label class="muted" style="font-size:12px;">Rows per page
                <select id="rowsPerPage" class="select">
                  <option>25</option><option selected>50</option><option>100</option><option>200</option>
                </select>
              </label>
              <div class="colpick">
                <button id="colBtn" class="btn">Columns ▾</button>
                <div id="colPanel" class="colpanel" hidden>
                  <h4>Toggle columns</h4>
                  <div id="colChecks"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="table-wrap">
            <table id="table">
              <thead><tr id="theadRow"></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px;">
            <div class="muted" style="font-size:12px;">Showing <span id="showingRange">0–0</span> of <span id="totalRows">0</span></div>
            <div style="display:flex; align-items:center; gap:8px;">
              <button id="prevPage" class="btn">◀ Prev</button>
              <div class="muted" style="font-size:12px;">Page <span id="pageNum">1</span> / <span id="pageCount">1</span></div>
              <button id="nextPage" class="btn">Next ▶</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="wrap" style="padding-bottom:28px;">
      <div class="muted" style="text-align:center; font-size:12px;">Built with Papa Parse + Chart.js • Client-only</div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>

  <script>
    Chart.defaults.font.family = "Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
    Chart.defaults.color = "#334155";
    Chart.defaults.plugins.legend.labels.boxWidth = 14;

    const state = {
      rows: [], filtered: [], columns: [],
      artistIndex: [], classIndex: [], tagIndex: [],
      artistSel: [], classSel: [], tagSel: [],
      sortKey: 'title', sortDir: 'asc',
      page: 1, pageSize: 50,
      colDefs: [
        { key:'image_url',           label:'Image',          visible:true,  type:'img'   },
        { key:'title',               label:'Title',          visible:true,  type:'text'  },
        { key:'artist_display_name', label:'Artist(s)',      visible:true,  type:'multi' },
        { key:'artist_nationality',  label:'Nationality',    visible:true,  type:'multi' },
        { key:'department',          label:'Department',     visible:true,  type:'multi' },
        { key:'classification',      label:'Classification', visible:true,  type:'multi' },
        { key:'medium',              label:'Medium',         visible:true,  type:'multi' },
        { key:'object_begin_date',   label:'Begin',          visible:true,  type:'num'   },
        { key:'object_end_date',     label:'End',            visible:true,  type:'num'   }
      ]
    };
    const el = (id) => document.getElementById(id);

    // Sidebar elements
    const fileInput = el('fileInput'), q = el('q'), yearMin = el('yearMin'), yearMax = el('yearMax');
    const yearMinVal = el('yearMinVal'), yearMaxVal = el('yearMaxVal'), status = el('status'), errors = el('errors');
    const exportBtn = el('exportBtn'), clearBtn = el('clearBtn');

    // Typeahead elements
    const artistInput = el('artistInput'), artistList = el('artistList'), artistToggle = el('artistToggle'), artistClear = el('artistClear'), artistChips = el('artistChips');
    const classInput = el('classInput'), classList = el('classList'), classToggle = el('classToggle'), classClear = el('classClear'), classChips = el('classChips');
    const tagsInput = el('tagsInput'), tagsList = el('tagsList'), tagsToggle = el('tagsToggle'), tagsClear = el('tagsClear'), tagsChips = el('tagsChips');

    // Results elements
    const rowsPerPage = el('rowsPerPage'), prevPage = el('prevPage'), nextPage = el('nextPage');
    const pageNum = el('pageNum'), pageCount = el('pageCount'), showingRange = el('showingRange'), totalRows = el('totalRows');
    const count = el('count');

    // Column picker
    const colBtn = el('colBtn'), colPanel = el('colPanel'), colChecks = el('colChecks');

    // ---------- Events ----------
    fileInput.addEventListener('change', (e) => { const file = e.target.files?.[0]; if (!file) return; errors.textContent=''; loadCSV(file); });
    clearBtn.addEventListener('click', () => {
      q.value='';
      setSelections('artist', []); setSelections('class', []); setSelections('tags', []);
      state.page = 1; state.sortKey='title'; state.sortDir='asc';
      if (state.rows.length) applyFilters();
    });
    q.addEventListener('input', debounce(() => { state.page=1; applyFilters(); }, 150));

    rowsPerPage.addEventListener('change', () => { state.pageSize = +rowsPerPage.value; state.page = 1; renderPaged(); });
    prevPage.addEventListener('click', () => { if (state.page > 1) { state.page--; renderPaged(); } });
    nextPage.addEventListener('click', () => { const pc = Math.max(1, Math.ceil(state.filtered.length / state.pageSize)); if (state.page < pc) { state.page++; renderPaged(); } });

    colBtn.addEventListener('click', () => { colPanel.hidden = !colPanel.hidden; });
    document.addEventListener('click', (e) => {
      if (!colPanel.contains(e.target) && e.target !== colBtn) colPanel.hidden = true;
    });

    function renderColumnPicker() {
      colChecks.innerHTML = '';
      for (const c of state.colDefs) {
        const id = 'col_' + c.key;
        const wrap = document.createElement('label');
        wrap.innerHTML = `<input id="${id}" type="checkbox" ${c.visible ? 'checked' : ''}/> <span>${c.label}</span>`;
        colChecks.appendChild(wrap);
        wrap.querySelector('input').addEventListener('change', (ev) => {
          c.visible = ev.target.checked; renderTableHeader(); renderPaged();
        });
      }
    }

    // Typeahead wiring
    function wireTypeahead(kind, inputEl, listEl, toggleBtn, clearBtn) {
      toggleBtn.addEventListener('click', () => { inputEl.focus(); showList(kind, inputEl.value); });
      clearBtn.addEventListener('click', () => { inputEl.value=''; setSelections(kind, []); hideList(kind); state.page=1; applyFilters(); });
      inputEl.addEventListener('input', () => { showList(kind, inputEl.value); });
      inputEl.addEventListener('focus', () => { showList(kind, inputEl.value); });
      inputEl.addEventListener('keydown', (e) => handleListKey(e, kind));
    }
    wireTypeahead('artist', artistInput, artistList, artistToggle, artistClear);
    wireTypeahead('class', classInput, classList, classToggle, classClear);
    wireTypeahead('tags',  tagsInput,  tagsList,  tagsToggle,  tagsClear);

    document.addEventListener('click', (e) => {
      const inside = (elem) => elem && (elem.contains(e.target) || e.target === elem);
      if (!inside(artistList) && !inside(artistInput) && e.target !== artistToggle) hideList('artist');
      if (!inside(classList)  && !inside(classInput)  && e.target !== classToggle)  hideList('class');
      if (!inside(tagsList)   && !inside(tagsInput)   && e.target !== tagsToggle)   hideList('tags');
    });

    function handleListKey(e, kind) {
      const listEl = kind === 'artist' ? artistList : kind === 'class' ? classList : tagsList;
      const inputEl = kind === 'artist' ? artistInput : kind === 'class' ? classInput : tagsInput;
      const opts = [...listEl.querySelectorAll('.option')];
      const cur = opts.findIndex(o => o.getAttribute('aria-selected') === 'true');
      if (e.key === 'ArrowDown') { e.preventDefault(); const idx = Math.min(cur + 1, opts.length - 1); selectOption(opts, idx); }
      else if (e.key === 'ArrowUp') { e.preventDefault(); const idx = Math.max(cur - 1, 0); selectOption(opts, idx); }
      else if (e.key === 'Enter') {
        e.preventDefault();
        const value = cur >= 0 ? opts[cur].dataset.value : inputEl.value.trim();
        if (value) { addSelection(kind, value); inputEl.value=''; showList(kind, ''); state.page=1; applyFilters(); }
      } else if (e.key === 'Escape') { hideList(kind); }
    }

    function selectOption(opts, idx) {
      opts.forEach(o => o.setAttribute('aria-selected', 'false'));
      if (idx >= 0 && idx < opts.length) {
        opts[idx].setAttribute('aria-selected', 'true');
        opts[idx].scrollIntoView({ block: 'nearest' });
      }
    }

    function showList(kind, query) {
      const ql = (query || '').toLowerCase();
      const idx = kind === 'artist' ? state.artistIndex : kind === 'class' ? state.classIndex : state.tagIndex;
      const listEl = kind === 'artist' ? artistList : kind === 'class' ? classList : tagsList;
      const inputEl = kind === 'artist' ? artistInput : kind === 'class' ? classInput : tagsInput;
      const items = idx.filter(a => !ql || a.toLowerCase().includes(ql)).slice(0, 60);
      listEl.innerHTML = items.map((a, i) => `<div class="option" role="option" aria-selected="${i===0?'true':'false'}" data-value="${escapeHTML(a)}">${escapeHTML(a)}</div>`).join('');
      listEl.hidden = items.length === 0;
      inputEl.setAttribute('aria-expanded', String(!listEl.hidden));
      [...listEl.querySelectorAll('.option')].forEach(opt => {
        opt.addEventListener('mouseenter', () => { [...listEl.querySelectorAll('.option')].forEach(o=>o.setAttribute('aria-selected','false')); opt.setAttribute('aria-selected','true'); });
        opt.addEventListener('click', () => { addSelection(kind, opt.dataset.value); showList(kind, ''); state.page=1; applyFilters(); });
      });
    }
    function hideList(kind) {
      const listEl = kind === 'artist' ? artistList : kind === 'class' ? classList : tagsList;
      const inputEl = kind === 'artist' ? artistInput : kind === 'class' ? classInput : tagsInput;
      listEl.hidden = true; inputEl.setAttribute('aria-expanded', 'false');
    }

    function setSelections(kind, arr) {
      const uniq = Array.from(new Set(arr.map(x => String(x).trim()).filter(Boolean)));
      if (kind === 'artist') state.artistSel = uniq;
      if (kind === 'class')  state.classSel  = uniq;
      if (kind === 'tags')   state.tagSel    = uniq;
      renderChips(kind);
    }
    function addSelection(kind, value) {
      const v = String(value).trim(); if (!v) return;
      if (kind === 'artist') setSelections('artist', [...state.artistSel, v]);
      if (kind === 'class')  setSelections('class',  [...state.classSel,  v]);
      if (kind === 'tags')   setSelections('tags',   [...state.tagSel,    v]);
    }
    function removeSelection(kind, value) {
      if (kind === 'artist') setSelections('artist', state.artistSel.filter(x => x !== value));
      if (kind === 'class')  setSelections('class',  state.classSel.filter(x => x !== value));
      if (kind === 'tags')   setSelections('tags',   state.tagSel.filter(x => x !== value));
      state.page=1; applyFilters();
    }

    function renderChips(kind) {
      const host = (kind === 'artist') ? document.getElementById('artistChips')
                : (kind === 'class')  ? document.getElementById('classChips')
                :                       document.getElementById('tagsChips');
      const list = (kind === 'artist') ? (state.artistSel || [])
                : (kind === 'class')  ? (state.classSel || [])
                :                       (state.tagSel || []);
      if (!host) return;
      host.innerHTML = '';
      host.style.display = list.length ? 'flex' : 'none';
      for (const v of list) {
        const span = document.createElement('span');
        span.className = 'chip';
        span.innerHTML = `${escapeHTML(v)} <button title="Remove" aria-label="Remove">✕</button>`;
        span.querySelector('button').addEventListener('click', () => removeSelection(kind, v));
        host.appendChild(span);
      }
    }

    function loadCSV(file) {
      status.textContent = 'Parsing…';
      try {
        Papa.parse(file, {
          header: true, dynamicTyping: true, skipEmptyLines: true,
          transformHeader: (h) => (h || '').toString().trim(),
          complete: (res) => {
            if (res.errors && res.errors.length) errors.textContent = 'Parser warnings/errors:\\n' + res.errors.slice(0,5).map(e => e.message + ' @ row ' + e.row).join('\\n');
            if (!res.data || !res.data.length) { status.textContent = 'No rows found.'; return; }
            const cols = res.meta && res.meta.fields ? res.meta.fields.map(c => c.trim()) : Object.keys(res.data[0]);
            state.rows = res.data.map(r => normalizeRow(r));
            state.columns = cols;
            buildIndexes(state.rows);
            status.textContent = `Loaded ${state.rows.length.toLocaleString()} rows • ${state.columns.length} columns`;
            applyFilters();
          },
          error: (err) => { console.error(err); status.textContent = 'Error parsing CSV'; errors.textContent = String(err); }
        });
      } catch (ex) { status.textContent = 'Error parsing CSV'; errors.textContent = String(ex && ex.stack || ex); }
    }

    function normalizeRow(r){
      // Map MoMA Artworks.csv headers to internal keys used by the app
      const get = (k)=> (r[k]===undefined||r[k]===null)?'':String(r[k]);
      return {
        title: get('Title'),
        artist_display_name: get('Artist'),
        artist_nationality: get('Nationality'),
        department: get('Department'),
        classification: get('Classification'),
        medium: get('Medium'),
        object_begin_date: get('BeginDate'),
        object_end_date: get('EndDate'),
        date_text: get('Date'),
        object_url: get('URL'),
        image_url: get('ImageURL'),

        // extras (kept in row for export/toggling later if desired)
        constituent_id: get('ConstituentID'),
        artist_bio: get('ArtistBio'),
        gender: get('Gender'),
        dimensions: get('Dimensions'),
        credit_line: get('CreditLine'),
        accession_number: get('AccessionNumber'),
        date_acquired: get('DateAcquired'),
        cataloged: get('Cataloged'),
        object_id: get('ObjectID'),
        on_view: get('OnView'),
        circumference_cm: get('Circumference (cm)'),
        depth_cm: get('Depth (cm)'),
        diameter_cm: get('Diameter (cm)'),
        height_cm: get('Height (cm)'),
        length_cm: get('Length (cm)'),
        weight_kg: get('Weight (kg)'),
        width_cm: get('Width (cm)'),
        seat_height_cm: get('Seat Height (cm)'),
        duration_sec: get('Duration (sec.)')
      };
    }

    function applyFilters() {
      const query = (q.value || '').toLowerCase().trim();
      const filtered = [];
      for (const r of state.rows) {
        const t = (r.title||'').toLowerCase();
        const d = (r.department||'').toLowerCase();
        const cl = (r.classification||'').toLowerCase();
        const a = (r.artist_display_name||'').toLowerCase();
        const n = (r.artist_nationality||'').toLowerCase();
        const m = (r.medium||'').toLowerCase();
        const fields = [t, d, cl, a, n, m].join(' | ');
        if (query && !fields.includes(query)) continue;

        if (state.artistSel.length) {
          const rowArtists = splitArtists(r.artist_display_name).map(s => s.toLowerCase());
          if (!state.artistSel.some(v => rowArtists.includes(v.toLowerCase()))) continue;
        }
        if (state.classSel.length) {
          const rowClasses = splitMultiMOMA(r.classification).map(s => s.toLowerCase());
          if (!state.classSel.some(v => rowClasses.includes(v.toLowerCase()))) continue;
        }
        if (state.tagSel.length) {
          const rowTags = splitMultiMOMA(r.medium).map(s => s.toLowerCase());
          if (!state.tagSel.some(v => rowTags.includes(v.toLowerCase()))) continue;
        }

        filtered.push(r);
      }
      state.filtered = sortRows(filtered, state.sortKey, state.sortDir);
      document.getElementById('count').textContent = filtered.length.toLocaleString();
      document.getElementById('totalRows').textContent = filtered.length.toLocaleString();
      state.page = 1;
      renderColumnPicker();
      renderTableHeader();
      renderPaged();
      renderDeptChart(filtered);
    }

    function sortRows(rows, key, dir) {
      const def = state.colDefs.find(c => c.key === key) || { type:'text' };
      const multival = (v) => splitMulti(val(v))[0] || ''; // first value if multi
      const cmp = (a,b) => {
        let va = a[key], vb = b[key];
        if (def.type === 'num') { va = Number(va); vb = Number(vb); va = Number.isFinite(va)?va:NaN; vb = Number.isFinite(vb)?vb:NaN; }
        else { va = multival(va).toLowerCase(); vb = multival(vb).toLowerCase(); }
        if (va === vb || (Number.isNaN(va) && Number.isNaN(vb))) return 0;
        if (Number.isNaN(va)) return 1;
        if (Number.isNaN(vb)) return -1;
        return va < vb ? -1 : 1;
      };
      const sorted = rows.slice().sort(cmp);
      return dir === 'asc' ? sorted : sorted.reverse();
    }

    function renderTableHeader() {
      const theadRow = document.getElementById('theadRow');
      theadRow.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (const c of state.colDefs) {
        if (!c.visible) continue;
        const th = document.createElement('th');
        th.textContent = c.label;
        const sortSpan = document.createElement('span'); sortSpan.className = 'sort';
        const arrow = (state.sortKey === c.key) ? (state.sortDir === 'asc' ? '▲' : '▼') : '⇵';
        sortSpan.textContent = ' ' + arrow;
        th.appendChild(sortSpan);
        th.addEventListener('click', () => {
          if (state.sortKey === c.key) state.sortDir = (state.sortDir === 'asc' ? 'desc' : 'asc');
          else { state.sortKey = c.key; state.sortDir = 'asc'; }
          state.filtered = sortRows(state.filtered, state.sortKey, state.sortDir);
          renderTableHeader();
          renderPaged();
        });
        frag.appendChild(th);
      }
      theadRow.appendChild(frag);
    }

    function visibleCols() { return state.colDefs.filter(c => c.visible); }

    function renderPaged() {
      const pc = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
      if (state.page > pc) state.page = pc;
      document.getElementById('pageNum').textContent = state.page;
      document.getElementById('pageCount').textContent = pc;
      const start = (state.page - 1) * state.pageSize;
      const end = Math.min(state.filtered.length, start + state.pageSize);
      document.getElementById('showingRange').textContent = (state.filtered.length ? (start+1) : 0) + '–' + end;
      const pageRows = state.filtered.slice(start, end);
      renderTable(pageRows);
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#table tbody');
      tbody.innerHTML = '';
      const cols = visibleCols();
      for (const r of rows) {
        const tr = document.createElement('tr');
        for (const c of cols) {
          const td = document.createElement('td');
          if (c.type === 'img') {
            if (r.image_url) {
              const img = document.createElement('img');
              img.src = r.image_url; img.alt = '';
              img.style.width='64px'; img.style.height='64px'; img.style.objectFit='cover'; img.loading='lazy';
              td.appendChild(img);
            }
          } else if (c.type === 'multi') {
            const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.gap='6px';
            const vals = splitMulti(val(r[c.key]));
            for (const s0 of vals) {
              const s = s0.trim(); if (!s) continue;
              const span = document.createElement('span'); span.className = 'pill'; span.textContent = s;
              wrap.appendChild(span);
            }
            td.appendChild(wrap);
          } else {
            const v = c.type === 'num' ? num(r[c.key]) : val(r[c.key]);
            td.textContent = (v==null || (Number.isNaN(v) && c.type==='num')) ? '' : String(v);
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    function renderDeptChart(rows) {
      const ctx = document.getElementById('deptChart').getContext('2d');
      const counts = new Map();
      for (const r of rows) { const d = firstValue(splitMulti(r.classification)); counts.set(d, (counts.get(d) || 0) + 1); }
      const sorted = Array.from(counts.entries()).filter(([k]) => k).sort((a,b)=>b[1]-a[1]).slice(0,15);
      const labels = sorted.map(x=>x[0]); const data = sorted.map(x=>x[1]);
      const palette = [
        'rgba(59,130,246,0.75)','rgba(99,102,241,0.75)','rgba(6,182,212,0.75)','rgba(249,115,22,0.75)',
        'rgba(34,197,94,0.75)','rgba(244,63,94,0.75)','rgba(234,179,8,0.75)','rgba(2,132,199,0.75)',
        'rgba(16,185,129,0.75)','rgba(20,184,166,0.75)','rgba(245,158,11,0.75)','rgba(168,85,247,0.75)',
        'rgba(236,72,153,0.75)','rgba(59,130,246,0.55)','rgba(99,102,241,0.55)'
      ];
      const borders = palette.map(c => c.replace('0.75','1').replace('0.55','0.9'));
      if (window._deptChart) window._deptChart.destroy();
      window._deptChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Count', data, backgroundColor: palette, borderColor: borders, borderWidth: 1, borderRadius: 6 }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            x: { ticks: { color: '#475569' }, grid: { display:false } },
            y: { ticks: { color: '#475569' }, grid: { color: 'rgba(148,163,184,0.2)' } }
          },
          plugins: {
            legend: { labels: { color: '#0f172a' } },
            tooltip: { backgroundColor: 'rgba(15,23,42,0.9)', titleColor:'#fff', bodyColor:'#e2e8f0', borderColor:'#1f2937', borderWidth:1 }
          }
        }
      });
    }

    // Helpers
    function num(v) { const n = Number(v); return Number.isFinite(n) ? n : NaN; }
    function val(v) { return (v === null || v === undefined) ? '' : String(v); }
    function splitMulti(value) {
      if (value == null) return [];
      return String(value).split(/[|;,]/).map(x => x.trim()).filter(Boolean);
    }
    function splitArtists(s) { return splitMulti(s); }
    function splitMultiMOMA(s) { return splitMulti(s); }
    function firstValue(arr) { return (arr && arr.length) ? arr[0] : ''; }
    function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; }
    function escapeHTML(s) { return String(s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }

    function toCSV(rows, cols) { if (!cols || !cols.length) cols = Object.keys(rows[0] || {}); const header = cols.join(','); const lines = [header]; for (const r of rows) { const line = cols.map(k => csvEscape(r[k])); lines.push(line.join(',')); } return lines.join('\\n'); }
    function csvEscape(v) { if (v === null || v === undefined) return ''; const s = String(v); if (/[",\\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"'; return s; }

    // Export filtered CSV
    document.getElementById('exportBtn').addEventListener('click', () => {
      if (!state.filtered.length) return;
      const csv = toCSV(state.filtered, state.columns);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'moma_filtered.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // Build the initial header and column picker on load
    renderColumnPicker();
    renderTableHeader();

    // --- Year slider (noUiSlider) ---
    const yearSlider = document.getElementById('yearSlider');
    const yearMinBox = document.getElementById('yearMinBox');
    const yearMaxBox = document.getElementById('yearMaxBox');

    function yearLabel(y) { y = Math.round(+y); return (y < 0) ? `${Math.abs(y)} BCE` : `${y} CE`; }
    function clamp(v) { v = Math.round(+v); if (!Number.isFinite(v)) return 0; return Math.max(-600, Math.min(2025, v)); }

    if (yearSlider && window.noUiSlider) {
      noUiSlider.create(yearSlider, {
        start: [-600, 2025],
        connect: true,
        step: 1,
        range: { min: -600, max: 2025 },
        tooltips: [ { to: yearLabel, from: Number }, { to: yearLabel, from: Number } ],
        pips: { mode: 'positions', values: [0, 20, 40, 60, 80, 100], density: 3, format: { to: (v)=>Math.round(v), from: Number } }
      });

      const hiddenMin = document.getElementById('yearMin');
      const hiddenMax = document.getElementById('yearMax');
      const yrMinVal = document.getElementById('yearMinVal');
      const yrMaxVal = document.getElementById('yearMaxVal');

      yearSlider.noUiSlider.on('update', (vals) => {
        const a = clamp(vals[0]), b = clamp(vals[1]);
        if (hiddenMin) hiddenMin.value = String(a);
        if (hiddenMax) hiddenMax.value = String(b);
        if (yearMinBox) yearMinBox.value = String(a);
        if (yearMaxBox) yearMaxBox.value = String(b);
        if (yrMinVal) yrMinVal.textContent = String(a);
        if (yrMaxVal) yrMaxVal.textContent = String(b);
      });

      yearSlider.noUiSlider.on('change', () => { state.page = 1; applyFilters(); });

      function setFromBoxes() {
        const a = clamp(yearMinBox.value), b = clamp(yearMaxBox.value);
        const lo = Math.min(a,b), hi = Math.max(a,b);
        yearSlider.noUiSlider.set([lo, hi]);
        state.page = 1; applyFilters();
      }
      ['change','blur','keydown'].forEach(evt => {
        yearMinBox.addEventListener(evt, (e)=>{ if (evt!=='keydown' || e.key==='Enter') setFromBoxes(); });
        yearMaxBox.addEventListener(evt, (e)=>{ if (evt!=='keydown' || e.key==='Enter') setFromBoxes(); });
      });

      document.querySelectorAll('[data-range]').forEach(btn => {
        btn.addEventListener('click', () => {
          const val = btn.getAttribute('data-range');
          if (val === 'all') { yearSlider.noUiSlider.set([-600, 2025]); }
          else {
            const [a,b] = val.split(',').map(Number);
            yearSlider.noUiSlider.set([clamp(a), clamp(b)]);
          }
          state.page = 1; applyFilters();
        });
      });
    }
  </script>
  <script>
/* ---- ensure buildIndexes exists before loadCSV calls it ---- */
function buildIndexes(rows){
  // local splitter so we don't depend on other helpers being declared yet
  const splitMultiLocal = (v) =>
    v == null ? [] : String(v).split(/[|;,]/).map(s => s.trim()).filter(Boolean);

  const aSet = new Set(), cSet = new Set(), tSet = new Set();

  for (const r of rows) {
    splitMultiLocal(r.artist_display_name).forEach(s => s && aSet.add(s));
    splitMultiLocal(r.classification).forEach(s => s && cSet.add(s));
    splitMultiLocal(r.medium).forEach(s => s && tSet.add(s));
  }

  state.artistIndex = Array.from(aSet).sort((a,b)=>a.localeCompare(b));
  state.classIndex  = Array.from(cSet).sort((a,b)=>a.localeCompare(b));
  state.tagIndex    = Array.from(tSet).sort((a,b)=>a.localeCompare(b));
}
</script>
</body>
</html>
